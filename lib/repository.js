"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _regenerator=_interopRequireDefault(require("@babel/runtime/regenerator")),_asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator")),_classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),_defineProperty2=_interopRequireDefault(require("@babel/runtime/helpers/defineProperty")),_v=_interopRequireDefault(require("uuid/v4"));function ownKeys(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);e&&(n=n.filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})),t.push.apply(t,n)}return t}function _objectSpread(r){for(var e=1;e<arguments.length;e++){var t=null!=arguments[e]?arguments[e]:{};e%2?ownKeys(Object(t),!0).forEach(function(e){(0,_defineProperty2.default)(r,e,t[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):ownKeys(Object(t)).forEach(function(e){Object.defineProperty(r,e,Object.getOwnPropertyDescriptor(t,e))})}return r}var Repository=function(){function o(e){var s=this,r=e.eventStore,t=e.constructor,n=e.aggregateType,a=e.snapshots,u=void 0===a||a;(0,_classCallCheck2.default)(this,o),(0,_defineProperty2.default)(this,"get",function(){var r=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function e(r){var t,n,a,u,o;return _regenerator.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,s.eventStore.getEvents({aggregateType:s.aggregateType,aggregateId:r});case 2:if(n=e.sent,a=n.events,(u=n.snapshot)||a.length){e.next=7;break}return e.abrupt("return",null);case 7:if(o=new s.Constructor({id:r,events:a,snapshot:null==u?void 0:u.body,version:null==u?void 0:u.version}),s.snapshots&&((null===(t=o.$snapshotSchedule)||void 0===t?void 0:t.every)||Number.MAX_VALUE)<=a.length)return e.next=11,s.eventStore.saveSnapshot(s.aggregateType,o);e.next=11;break;case 11:return e.abrupt("return",o);case 12:case"end":return e.stop()}},e)}));return function(e){return r.apply(this,arguments)}}()),(0,_defineProperty2.default)(this,"create",function(e){return new s.Constructor({id:e||(0,_v.default)()})}),(0,_defineProperty2.default)(this,"record",function(){var r=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function e(r){var t;return _regenerator.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,s.eventStore.record(r.map(function(e){return _objectSpread({},e,{aggregate:s.aggregateType})}));case 2:return t=e.sent,e.next=5,s.notifySubscribers(t);case 5:case"end":return e.stop()}},e)}));return function(e){return r.apply(this,arguments)}}()),(0,_defineProperty2.default)(this,"notifySubscribers",function(){var r=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function e(t){return _regenerator.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Promise.all(s.subscriptions.map(function(){var r=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function e(r){return _regenerator.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,r(t);case 3:return e.abrupt("return",e.sent);case 6:return e.prev=6,e.t0=e.catch(0),console.log(e.t0),e.abrupt("return",null);case 10:case"end":return e.stop()}},e,null,[[0,6]])}));return function(e){return r.apply(this,arguments)}}()));case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}},e)}));return function(e){return r.apply(this,arguments)}}()),(0,_defineProperty2.default)(this,"getEvents",function(){var r=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function e(r){return _regenerator.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,s.eventStore.getEvents({aggregateType:s.aggregateType,aggregateId:r});case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}},e)}));return function(e){return r.apply(this,arguments)}}()),this.eventStore=r,this.aggregateType=n,this.Constructor=t,this.snapshots=u,this.subscriptions=[]}return(0,_createClass2.default)(o,[{key:"subscribe",value:function(e){this.subscriptions.push(e)}}]),o}();exports.default=Repository;
//# sourceMappingURL=maps/repository.js.map
