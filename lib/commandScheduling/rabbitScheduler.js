"use strict";var _interopRequireWildcard=require("@babel/runtime/helpers/interopRequireWildcard"),_interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _regenerator=_interopRequireDefault(require("@babel/runtime/regenerator")),_asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator")),_classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_defineProperty2=_interopRequireDefault(require("@babel/runtime/helpers/defineProperty")),_identity=_interopRequireDefault(require("../auth/identity")),_schedule=_interopRequireDefault(require("./schedule")),_commandFailure=_interopRequireWildcard(require("./commandFailure")),RabbitScheduler=function e(r){var c=this,u=r.channel,t=r.clock,n=r.deliverer;(0,_classCallCheck2.default)(this,e),(0,_defineProperty2.default)(this,"schedule",function(){var r=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function e(r){var t,n,a,u,i;return _regenerator.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=r.service,n=r.target,a=r.clock,u=r.due,(i=r.command).$identity=_identity.default.system,i.$scheduler=new _schedule.default({service:t,target:n,due:u,clock:a||c.clock}),e.next=5,c.publish(JSON.stringify(i));case 5:case"end":return e.stop()}},e)}));return function(e){return r.apply(this,arguments)}}()),(0,_defineProperty2.default)(this,"execute",function(){var r=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function e(r){var t,n,a;return _regenerator.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=r.service,n=r.target,(a=r.command).$identity=_identity.default.system,a.$scheduler=new _schedule.default({service:t,target:n}),e.next=5,c.deliver(a);case 5:case"end":return e.stop()}},e)}));return function(e){return r.apply(this,arguments)}}()),(0,_defineProperty2.default)(this,"deliver",function(){var r=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function e(n){return _regenerator.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise(function(){var t=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function e(r,t){return _regenerator.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,n.$scheduler.due=null,e.next=4,c.deliverer.deliver({service:n.$scheduler.service,target:n.$scheduler.target,command:n});case 4:r(),e.next=10;break;case 7:e.prev=7,e.t0=e.catch(0),t(e.t0);case 10:case"end":return e.stop()}},e,null,[[0,7]])}));return function(e,r){return t.apply(this,arguments)}}()));case 1:case"end":return e.stop()}},e)}));return function(e){return r.apply(this,arguments)}}()),this.channel=u,this.clock=t,this.deliverer=n;var a="scheduledCommands";u.assertQueue(a,{durable:!0}).then(function(){return u.consume(a,function(){var r=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function e(n){var a;return _regenerator.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return a=JSON.parse(n.content),e.next=3,c.deliver(a).then(function(){u.ack(n)}).catch(function(){var r=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function e(r){var t;return _regenerator.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t=new _commandFailure.default({error:r,command:a}),!r.handler){e.next=4;break}return e.next=4,r.handler.handleDeliveryError(t,r.aggregate);case 4:u.nack(n,!1,t.failureAction instanceof _commandFailure.Retry&&!n.fields.redelivered);case 5:case"end":return e.stop()}},e)}));return function(e){return r.apply(this,arguments)}}());case 3:case"end":return e.stop()}},e)}));return function(e){return r.apply(this,arguments)}}())}),this.publish=function(){var r=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function e(r){return _regenerator.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,u.sendToQueue(a,Buffer.from(r));case 2:case"end":return e.stop()}},e)}));return function(e){return r.apply(this,arguments)}}()};exports.default=RabbitScheduler;
//# sourceMappingURL=../maps/commandScheduling/rabbitScheduler.js.map
