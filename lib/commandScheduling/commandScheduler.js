"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _queue=_interopRequireDefault(require("async/queue")),_identity=_interopRequireDefault(require("../auth/identity")),_schedule=_interopRequireDefault(require("./schedule")),_commandFailure=_interopRequireDefault(require("./commandFailure"));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _asyncToGenerator(e){return function(){var r=this,t=arguments;return new Promise(function(n,a){var u=e.apply(r,t);function i(e,r){try{var t=u[e](r),i=t.value}catch(e){return void a(e)}t.done?n(i):Promise.resolve(i).then(c,s)}function c(e){i("next",e)}function s(e){i("throw",e)}c()})}}function _classCallCheck(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}var CommandScheduler=function e(r){var t=this,n=r.store,a=r.clock,u=r.deliverer;_classCallCheck(this,e),_initialiseProps.call(this),this.store=n,this.clock=a,this.deliverer=u,this.queue=(0,_queue.default)(function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(r,n){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!r.$scheduler.isDue(a.now())){e.next=5;break}return e.next=3,t.deliver(r);case 3:e.next=6;break;case 5:setTimeout(function(){return t.queue.push(r)},1e3);case 6:return e.abrupt("return",n());case 7:case"end":return e.stop()}},e,this)}));return function(r,t){return e.apply(this,arguments)}}()),setImmediate(_asyncToGenerator(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=t.queue,e.next=3,t.store.loadCommands();case 3:return e.t1=e.sent,e.abrupt("return",e.t0.push.call(e.t0,e.t1));case 5:case"end":return e.stop()}},e,this)})))};exports.default=CommandScheduler;var _initialiseProps=function(){var e,r,t,n=this;Object.defineProperty(this,"schedule",{configurable:!0,enumerable:!0,writable:!0,value:(e=_asyncToGenerator(regeneratorRuntime.mark(function e(r){var t,a,u,i,c;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=r.service,a=r.target,u=r.clock,i=r.due,(c=r.command).$identity=_identity.default.system,c.$scheduler=new _schedule.default({service:t,target:a,due:i,clock:u||n.clock,attempts:0}),e.t0=n.queue,e.next=6,n.store.push(c);case 6:return e.t1=e.sent,e.next=9,e.t0.push.call(e.t0,e.t1);case 9:case"end":return e.stop()}},e,this)})),function(r){return e.apply(this,arguments)})}),Object.defineProperty(this,"execute",{configurable:!0,enumerable:!0,writable:!0,value:(r=_asyncToGenerator(regeneratorRuntime.mark(function e(r){var t,a,u;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=r.service,a=r.target,(u=r.command).$identity=_identity.default.system,u.$scheduler=new _schedule.default({service:t,target:a,attempts:0}),e.next=5,n.deliver(u,!0);case 5:case"end":return e.stop()}},e,this)})),function(e){return r.apply(this,arguments)})}),Object.defineProperty(this,"deliver",{configurable:!0,enumerable:!0,writable:!0,value:(t=_asyncToGenerator(regeneratorRuntime.mark(function e(r){var t,a,u=arguments;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=u.length>1&&void 0!==u[1]&&u[1],e.prev=1,r.$scheduler.due=null,e.next=5,n.deliverer.deliver({service:r.$scheduler.service,target:r.$scheduler.target,command:r});case 5:if(r.$scheduler.attempts=r.$scheduler.attempts+1,t){e.next=14;break}if(!r.$scheduler.due){e.next=12;break}return e.next=10,n.store.retry(r);case 10:e.next=14;break;case 12:return e.next=14,n.store.complete(r);case 14:e.next=34;break;case 16:if(e.prev=16,e.t0=e.catch(1),a=new _commandFailure.default({error:e.t0,command:r}),e.t0.handler){e.next=22;break}throw console.log("Unhandled error",e.t0),e.t0;case 22:return e.next=24,e.t0.handler.handleDeliveryError(a,e.t0.aggregate);case 24:if(t){e.next=34;break}if(!r.$scheduler.due){e.next=30;break}return e.next=28,n.store.retry(r);case 28:e.next=34;break;case 30:if(!a.cancelled){e.next=34;break}return console.log("retry cancelled"),e.next=34,n.store.complete(r);case 34:case"end":return e.stop()}},e,this,[[1,16]])})),function(e){return t.apply(this,arguments)})})};
//# sourceMappingURL=../maps/commandScheduling/commandScheduler.js.map
