"use strict";var _interopRequireWildcard=require("@babel/runtime/helpers/interopRequireWildcard"),_interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _regenerator=_interopRequireDefault(require("@babel/runtime/regenerator")),_slicedToArray2=_interopRequireDefault(require("@babel/runtime/helpers/slicedToArray")),_asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator")),_classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_defineProperty2=_interopRequireDefault(require("@babel/runtime/helpers/defineProperty")),_identity=_interopRequireDefault(require("../auth/identity")),_schedule=_interopRequireDefault(require("./schedule")),_commandFailure=_interopRequireWildcard(require("./commandFailure")),_tasks=require("@google-cloud/tasks"),TaskScheduler=function e(r){var d=this,t=r.credentials,a=r.deliveryPath,i=r.location,u=void 0===i?"us-central1":i,l=r.project,n=r.queue,s=r.rootUrl,c=r.secret;(0,_classCallCheck2.default)(this,e),(0,_defineProperty2.default)(this,"schedule",function(){var r=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function e(r){var t,a,i,u,l,n,s,c,o;return _regenerator.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=r.aggregate,a=r.service,i=r.target,u=r.seconds,(l=r.command).$identity=_identity.default.system,l.$scheduler=new _schedule.default({secret:d.secret,service:a||t,target:i,seconds:u}),n=d.client.queuePath(d.project,d.location,d.queue),s={httpRequest:{httpMethod:"POST",url:d.deliveryUrl,body:Buffer.from(JSON.stringify(l)).toString("base64")}},u&&(s.scheduleTime={seconds:Date.now()/1e3+u}),e.prev=6,e.next=9,d.client.createTask({parent:n,task:s});case 9:c=e.sent,o=(0,_slicedToArray2.default)(c,1),o[0],console.log("created gcloud task ".concat(a||t,"/").concat(i)),e.next=18;break;case 15:e.prev=15,e.t0=e.catch(6),console.error("Error creating Gcloud Task",e.t0);case 18:case"end":return e.stop()}},e,null,[[6,15]])}));return function(e){return r.apply(this,arguments)}}()),this.project=l,this.queue=n,this.location=u,this.deliveryUrl="".concat(s,"/").concat(a),this.client=new _tasks.v2beta3.CloudTasksClient({credentials:t}),this.serviceAccountEmail=t.client_email,this.secret=c};exports.default=TaskScheduler;
//# sourceMappingURL=../maps/commandScheduling/taskScheduler.js.map
